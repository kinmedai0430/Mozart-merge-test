<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>固定ルート画像合成v3.2 (Worker対応)</title>
  <style>
    :root {
      --color-bg: #263238;
      --color-text: #eceff1;
      --color-dropzone-bg: #37474f;
      --color-dropzone-border: #b0bec5;
      --color-blue: #007bff;
      --color-blue-hover: #0056b3;
    }
    body {
      font-family: 'Inter', sans-serif;
      padding: 20px;
      background: var(--color-bg);
      color: var(--color-text);
      display: flex;
      justify-content: center;
      min-height: 100vh;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .main-content-wrapper {
        display: flex;
        flex-direction: column;
        gap: 20px;
        background: var(--color-dropzone-bg);
        padding: 20px;
        border-radius: 8px;
        max-width: 1200px;
        width: 100%;
    }
    .section {
        background: transparent;
        padding: 0;
        border-radius: 8px;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .preview-area {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      width: 100%;
    }
    .drop-zone {
      border: 2px dashed var(--color-dropzone-border);
      padding: 15px;
      text-align: center;
      margin-bottom: 15px;
      background: var(--color-dropzone-bg);
      color: var(--color-text);
      cursor: pointer;
      transition: border-color 0.2s ease, background-color 0.2s ease;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 120px;
      border-radius: 8px;
    }
    .drop-zone.qr {
      min-height: 100px;
    }
    .drop-zone.dragover {
      border-color: var(--color-blue);
      background-color: rgba(0, 123, 255, 0.1);
    }
    .preview-thumb {
      max-width: 100%;
      max-height: 80px;
      display: block;
      margin-top: 10px;
      border-radius: 4px;
    }
    .drop-zone p {
      margin: 0;
      font-size: 14px;
      opacity: 0.8;
    }
    input[type="file"] {
      display: none;
    }
    #canvas {
      display: none;
    }
    #preview {
      max-width: 100%;
      height: auto;
      border: 1px solid var(--color-dropzone-border);
      margin-bottom: 20px;
      border-radius: 8px;
    }
    .qr-group {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .qr-input-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .slider-group {
      width: 100%;
      margin-top: 10px;
      text-align: left;
    }
    input[type="range"] {
      width: 100%;
      height: 25px;
    }
    .button-group {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 20px;
    }
    #downloadButton, #clearButton {
      padding: 15px 20px;
      font-size: 18px;
      background-color: var(--color-blue);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      width: 100%;
      box-sizing: border-box;
    }
    #downloadButton:hover, #clearButton:hover {
      background-color: var(--color-blue-hover);
    }
    #clearButton {
        background-color: #dc3545;
    }
    #clearButton:hover {
        background-color: #c82333;
    }
    .controls-group {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 15px;
      justify-content: center;
      margin-bottom: 15px;
    }
    .hidden {
      display: none !important;
    }
    h2, h3 {
      font-weight: 500;
      margin-top: 0;
      text-align: center;
      color: var(--color-blue);
    }
    input[type="text"] {
      padding: 10px;
      background: #263238;
      border: 1px solid #b0bec5;
      color: #eceff1;
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
    }
    input[type="checkbox"] {
      accent-color: var(--color-blue);
    }
    .tip-text {
        font-size: 14px;
        color: #b0bec5;
        margin-top: 10px;
    }
    .guide-text {
      font-size: 14px;
      margin-top: 0;
      line-height: 1.6;
    }
    hr {
      margin: 10px 0;
      border-color: #546e7a;
    }

    /* スマホ用 */
    #guide-section { order: 1; }
    #background-image-section { order: 2; }
    #qr-section { order: 3; }
    #settings-section { order: 4; }
    #preview-section { order: 5; }
    #individual-text-section { order: 6; }


    /* PC用 */
    @media (min-width: 768px) {
        body {
            padding: 40px;
        }
        .main-content-wrapper {
            display: grid;
            grid-template-columns: 1fr 2fr 1.5fr;
            grid-template-rows: auto auto;
            gap: 40px;
            padding: 40px;
        }
        .section {
            order: initial !important;
        }

        /* PCのUI(プレビュー前) */
        #settings-section { grid-column: 1; grid-row: 1; }
        #individual-text-section { grid-column: 1; grid-row: 2; }
        
        #preview-section { grid-column: 2; grid-row: 1; }
        #background-image-section { 
            grid-column: 2; 
            grid-row: 2;
            transform: translateY(-600px);
        }

        #qr-section { grid-column: 3; grid-row: 1; }
        #guide-section { grid-column: 3; grid-row: 2; align-self: start; }

        /*PCのUI(プレビュー後)*/
        .main-content-wrapper.preview-active #preview-section {
            grid-row: 1;
        }
        .main-content-wrapper.preview-active #background-image-section {
            grid-row: 2;
            transform: translateY(-50px);
        }

        .drop-zone {
            padding: 20px;
            min-height: 150px;
        }
        .drop-zone.qr {
            min-height: 120px;
        }
        .preview-thumb {
            max-height: 100px;
        }
        .qr-group {
            flex-direction: row;
        }
        .button-group {
            flex-direction: row;
        }
        #downloadButton, #clearButton {
            width: auto;
            padding: 15px 30px;
            font-size: 20px;
        }
        .guide-text {
            font-size: 16px;
        }
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="main-content-wrapper">
    <div id="settings-section" class="section">
      <h3>調整</h3>
      <div class="controls-group">
          <label>
            <input type="checkbox" id="toggleText" checked>QR上のテキストを表示
          </label>
          <div>
            <label for="textColorPicker">テキストの色</label>
            <input type="color" id="textColorPicker" value="#ffffff">
          </div>
      </div>
      <div class="slider-group">
        <label for="left-qr-offset">左QR位置調整</label>
        <input type="range" id="left-qr-offset" min="-700" max="800">
      </div>
      <div class="slider-group">
        <label for="right-qr-offset">右QR位置調整</label>
        <input type="range" id="right-qr-offset" min="-1200" max="200">
      </div>
      <div class="slider-group">
          <label for="top-qr-vertical-offset">上QR位置調整</label>
          <input type="range" id="top-qr-vertical-offset" min="-500" max="500">
      </div>
      <div class="slider-group">
          <label for="bottom-qr-vertical-offset">下QR位置調整</label>
          <input type="range" id="bottom-qr-vertical-offset" min="-500" max="500">
      </div>
      <div class="slider-group">
        <label for="bulkTextSize">QR上のテキストサイズ調整</label>
        <input type="range" id="bulkTextSize" min="10" max="200">
      </div>
      <div class="slider-group">
        <label for="qrSize">QRサイズ調整</label>
        <input type="range" id="qrSize" min="5" max="40">
      </div>
    </div>

    <div id="individual-text-section" class="section">
      <h3>個別テキスト表示</h3>
      <label>
        <input type="checkbox" id="individualTextToggle"> 個別テキストを表示
      </label>
      <div class="individual-text-controls hidden">
        <label for="individualText1">テキスト</label>
        <input type="text" id="individualText1" value="先など">
        <div class="slider-group">
            <label for="individualTextSize1">サイズ調整</label>
            <input type="range" id="individualTextSize1" min="10" max="200">
        </div>
        <div class="slider-group">
            <label for="individualTextX1">左右調整</label>
            <input type="range" id="individualTextX1" min="-500" max="1500">
        </div>
        <div class="slider-group">
            <label for="individualTextY1">上下調整</label>
            <input type="range" id="individualTextY1" min="-500" max="500">
        </div>
        <hr>
        <label>
          <input type="checkbox" id="individualTextToggle2"> 2つ目の個別テキストを表示
        </label>
        <div class="individual-text-controls2 hidden">
          <label for="individualText2">テキスト</label>
          <input type="text" id="individualText2" value="後など">
          <div class="slider-group">
              <label for="individualTextSize2">サイズ調整</label>
              <input type="range" id="individualTextSize2" min="10" max="200">
          </div>
          <div class="slider-group">
              <label for="individualTextX2">左右調整</label>
              <input type="range" id="individualTextX2" min="-1500" max="500">
          </div>
          <div class="slider-group">
              <label for="individualTextY2">上下調整</label>
              <input type="range" id="individualTextY2" min="-500" max="500">
          </div>
        </div>
      </div>
    </div>

    <div id="preview-section" class="section preview-area">
      <h3>合成画像プレビュー</h3>
      <img id="preview" alt="合成画像プレビュー" class="hidden">
      <div class="button-group">
          <button id="downloadButton" class="hidden">画像をダウンロード</button>
          <button id="clearButton" class="hidden">全て削除</button>
      </div>
      <p class="tip-text hidden" id="ios-download-tip">iPhone・iPadなどの方はプレビュー画像を<br>長押しして画像をダウンロードしてください</p>
    </div>

    <div id="background-image-section" class="section">
        <h2>背景画像</h2>
        <div class="drop-zone" id="mainDrop">
            <p>背景画像をここにドロップかクリック</p>
            <img id="mainThumb" class="preview-thumb hidden" alt="背景画像プレビュー">
        </div>
        <input type="file" accept="image/*" id="mainInput">
    </div>

    <div id="qr-section" class="section">
      <h3>QRコード</h3>
      <div class="qr-group">
        <div class="qr-input-group" data-id="leftTop">
          <label for="leftTopText">左上QRテキスト</label>
          <input type="text" id="leftTopText" value="先１">
          <div class="drop-zone qr" id="leftTopDrop">
              <p>左上QR画像をここにドロップかクリック</p>
              <img id="leftTopThumb" class="preview-thumb hidden" alt="左上QRプレビュー">
          </div>
          <input type="file" accept="image/*" id="leftTopInput">
        </div>
        <div class="qr-input-group" data-id="rightTop">
          <label for="rightTopText">右上QRテキスト</label>
          <input type="text" id="rightTopText" value="後１">
          <div class="drop-zone qr" id="rightTopDrop">
              <p>右上QR画像をここにドロップかクリック</p>
              <img id="rightTopThumb" class="preview-thumb hidden" alt="右上QRプレビュー">
          </div>
          <input type="file" accept="image/*" id="rightTopInput">
        </div>
      </div>
      <div class="qr-group">
        <div class="qr-input-group" data-id="leftQR">
          <label for="leftQRText">左下QRテキスト</label>
          <input type="text" id="leftQRText" value="先２">
          <div class="drop-zone qr" id="leftQRDrop">
              <p>左下QR画像をここにドロップかクリック</p>
              <img id="leftThumb" class="preview-thumb hidden" alt="左QRプレビュー">
          </div>
          <input type="file" accept="image/*" id="leftQRInput">
        </div>
        <div class="qr-input-group" data-id="rightQR">
          <label for="rightQRText">右下QRテキスト</label>
          <input type="text" id="rightQRText" value="後２">
          <div class="drop-zone qr" id="rightQRDrop">
              <p>右下QR画像をここにドロップかクリック</p>
              <img id="rightThumb" class="preview-thumb hidden" alt="右QRプレビュー">
          </div>
          <input type="file" accept="image/*" id="rightQRInput">
        </div>
      </div>
    </div>

    <div id="guide-section" class="section">
      <p class="guide-text">
        ①背景画像をアップロードしてください<br>
        ②0～4枚のQRコード画像をアップロードしてください<br>
        ③QR位置や個別テキストなどを調整してください
      </p>
    </div>

  </div>
  <canvas id="canvas"></canvas>
  <script>
  // Web Worker用のコードを文字列として定義
  const workerCode = `
    self.onmessage = (e) => {
      const { imgBitmaps, params } = e.data;
      const mainImg = imgBitmaps.main;
      if (!mainImg) {
        return;
      }
      
      const canvas = new OffscreenCanvas(mainImg.width, mainImg.height);
      const ctx = canvas.getContext('2d');
      
      ctx.drawImage(mainImg, 0, 0);

      // QRサイズをスライダーの値から計算
      const qrSizePercent = params.qrSize / 100;
      const qrWidth = mainImg.width * qrSizePercent;
      const qrHeight = qrWidth;
      const qrMargin = mainImg.width * 0.02;

      const topY = mainImg.height * 0.2 + params.topVertical;
      const bottomY = mainImg.height * 0.2 + params.bottomVertical + qrHeight;

      const qrPositions = {
        leftTop: { img: imgBitmaps.leftTop, x: qrMargin + 540 + params.leftOffset, y: topY, text: params.texts.leftTop },
        rightTop: { img: imgBitmaps.rightTop, x: mainImg.width - qrWidth - qrMargin + params.rightOffset, y: topY, text: params.texts.rightTop },
        leftQR: { img: imgBitmaps.leftQR, x: qrMargin + 540 + params.leftOffset, y: bottomY, text: params.texts.leftQR },
        rightQR: { img: imgBitmaps.rightQR, x: mainImg.width - qrWidth - qrMargin + params.rightOffset, y: bottomY, text: params.texts.rightQR }
      };

      for (const key in qrPositions) {
        const pos = qrPositions[key];
        if (pos.img) {
          ctx.drawImage(pos.img, pos.x, pos.y, qrWidth, qrHeight);
        }
      }

      ctx.fillStyle = params.textColor;
      ctx.textAlign = 'center';

      if (params.showGlobalText) {
        ctx.font = \`bold \${params.bulkTextSize}px Arial\`;
        for (const key in qrPositions) {
          const pos = qrPositions[key];
          if (pos.img && pos.text) {
            ctx.fillText(pos.text, pos.x + qrWidth / 2, pos.y - 40);
          }
        }
      }

      if (params.individualText.toggle1) {
        ctx.font = \`bold \${params.individualText.size1}px Arial\`;
        const baseX1 = canvas.width / 2 - 600;
        const baseY1 = canvas.height / 2;
        ctx.fillText(params.individualText.text1, baseX1 + params.individualText.x1, baseY1 + params.individualText.y1);
      }
      
      if (params.individualText.toggle1 && params.individualText.toggle2) {
        ctx.font = \`bold \${params.individualText.size2}px Arial\`;
        const baseX2 = canvas.width / 2 + 600;
        const baseY2 = canvas.height / 2;
        ctx.fillText(params.individualText.text2, baseX2 + params.individualText.x2, baseY2 + params.individualText.y2);
      }
      
      const finalBitmap = canvas.transferToImageBitmap();
      self.postMessage({ imageBitmap: finalBitmap }, [finalBitmap]);
    };
  `;

  document.addEventListener('DOMContentLoaded', () => {
    // --- Workerのセットアップ ---
    const blob = new Blob([workerCode], { type: 'application/javascript' });
    const worker = new Worker(URL.createObjectURL(blob));

    // --- デバイス別パラメータ設定 ---
    const desktopParams = {
        bulkTextSize: 65, leftOffset: 230, rightOffset: 0, topVertical: 20, bottomVertical: 350, qrSize: 15,
        indTextSize1: 80, indTextX1: 0, indTextY1: 0,
        indTextSize2: 80, indTextX2: 0, indTextY2: 0
    };
    const mobileParams = {
        bulkTextSize: 65, leftOffset: 230, rightOffset: 0, topVertical: 20, bottomVertical: 350, qrSize: 15,
        indTextSize1: 80, indTextX1: 0, indTextY1: 0,
        indTextSize2: 80, indTextX2: 0, indTextY2: 0
    };
    const isMobile = window.matchMedia('(max-width: 767px)').matches;
    const activeParams = isMobile ? mobileParams : desktopParams;
    
    // --- DOM要素と設定 ---
    const elements = {
      main: { input: 'mainInput', drop: 'mainDrop', thumb: 'mainThumb', img: null },
      leftTop: { input: 'leftTopInput', drop: 'leftTopDrop', thumb: 'leftTopThumb', text: 'leftTopText', img: null },
      rightTop: { input: 'rightTopInput', drop: 'rightTopDrop', thumb: 'rightTopThumb', text: 'rightTopText', img: null },
      leftQR: { input: 'leftQRInput', drop: 'leftQRDrop', thumb: 'leftThumb', text: 'leftQRText', img: null },
      rightQR: { input: 'rightQRInput', drop: 'rightQRDrop', thumb: 'rightThumb', text: 'rightQRText', img: null }
    };
    const mainWrapper = document.querySelector('.main-content-wrapper');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const preview = document.getElementById('preview');
    const downloadButton = document.getElementById('downloadButton');
    const clearButton = document.getElementById('clearButton');
    const iosTip = document.getElementById('ios-download-tip');
    
    const sliders = {
      bulkTextSize: { id: 'bulkTextSize', initial: activeParams.bulkTextSize },
      leftOffset: { id: 'left-qr-offset', initial: activeParams.leftOffset },
      rightOffset: { id: 'right-qr-offset', initial: activeParams.rightOffset },
      topVertical: { id: 'top-qr-vertical-offset', initial: activeParams.topVertical },
      bottomVertical: { id: 'bottom-qr-vertical-offset', initial: activeParams.bottomVertical },
      qrSize: { id: 'qrSize', initial: activeParams.qrSize }
    };
    
    const individualTextControls = {
      toggle: 'individualTextToggle', text1: 'individualText1',
      size1: { id: 'individualTextSize1', initial: activeParams.indTextSize1 },
      x1: { id: 'individualTextX1', initial: activeParams.indTextX1 },
      y1: { id: 'individualTextY1', initial: activeParams.indTextY1 },
      toggle2: 'individualTextToggle2', text2: 'individualText2',
      size2: { id: 'individualTextSize2', initial: activeParams.indTextSize2 },
      x2: { id: 'individualTextX2', initial: activeParams.indTextX2 },
      y2: { id: 'individualTextY2', initial: activeParams.indTextY2 }
    };
    
    const options = { toggleText: 'toggleText', textColor: 'textColorPicker' };
    const imgData = {};
    let isMerging = false;
    let mergeTimeout;

    // --- 関数定義 ---
    const loadImage = (file) => {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        const reader = new FileReader();
        reader.onload = e => img.src = e.target.result;
        reader.readAsDataURL(file);
      });
    };

    const showThumbnail = (file, dropZoneElem, imgElem) => {
      const reader = new FileReader();
      reader.onload = e => {
        imgElem.src = e.target.result;
        imgElem.classList.remove('hidden');
        dropZoneElem.querySelector('p').classList.add('hidden');
      };
      reader.readAsDataURL(file);
    };

    const initializeSliders = () => {
        for (const key in sliders) {
            document.getElementById(sliders[key].id).value = sliders[key].initial;
        }
        document.getElementById(individualTextControls.size1.id).value = individualTextControls.size1.initial;
        document.getElementById(individualTextControls.x1.id).value = individualTextControls.x1.initial;
        document.getElementById(individualTextControls.y1.id).value = individualTextControls.y1.initial;
        document.getElementById(individualTextControls.size2.id).value = individualTextControls.size2.initial;
        document.getElementById(individualTextControls.x2.id).value = individualTextControls.x2.initial;
        document.getElementById(individualTextControls.y2.id).value = individualTextControls.y2.initial;
    };
    
    const resetElements = () => {
      for (const name in elements) {
        const elem = elements[name];
        document.getElementById(elem.drop).querySelector('p').classList.remove('hidden');
        document.getElementById(elem.thumb).classList.add('hidden');
        document.getElementById(elem.thumb).src = '';
        document.getElementById(elem.input).value = '';
        imgData[name] = null;
      }
      document.getElementById(options.toggleText).checked = true;
      document.getElementById(options.textColor).value = '#ffffff';
      
      initializeSliders(); // デバイス別の初期値でリセット
      
      document.getElementById(individualTextControls.toggle).checked = false;
      document.querySelector('.individual-text-controls').classList.add('hidden');
      document.getElementById(individualTextControls.text1).value = '先など';
      document.getElementById(individualTextControls.toggle2).checked = false;
      document.querySelector('.individual-text-controls2').classList.add('hidden');
      document.getElementById(individualTextControls.text2).value = '後など';
      
      document.getElementById('leftTopText').value = '先１';
      document.getElementById('rightTopText').value = '後１';
      document.getElementById('leftQRText').value = '先２';
      document.getElementById('rightQRText').value = '後２';
      
      preview.classList.add('hidden');
      preview.src = '';
      downloadButton.classList.add('hidden');
      clearButton.classList.add('hidden');
      iosTip.classList.add('hidden');
      mainWrapper.classList.remove('preview-active');
      isMerging = false;
    };

    const scheduleMerge = () => {
        clearTimeout(mergeTimeout);
        mergeTimeout = setTimeout(async () => {
            if (isMerging || !imgData.main) return;
            isMerging = true;

            const imgPromises = Object.keys(imgData)
                .filter(key => imgData[key])
                .map(key => createImageBitmap(imgData[key]).then(bitmap => ({ key, bitmap })));

            const bitmapResults = await Promise.all(imgPromises);
            const imgBitmaps = bitmapResults.reduce((acc, { key, bitmap }) => {
                acc[key] = bitmap;
                return acc;
            }, {});
            
            const params = {
                bulkTextSize: parseInt(document.getElementById(sliders.bulkTextSize.id).value),
                leftOffset: parseInt(document.getElementById(sliders.leftOffset.id).value),
                rightOffset: parseInt(document.getElementById(sliders.rightOffset.id).value),
                topVertical: parseInt(document.getElementById(sliders.topVertical.id).value),
                bottomVertical: parseInt(document.getElementById(sliders.bottomVertical.id).value),
                qrSize: parseInt(document.getElementById(sliders.qrSize.id).value),
                textColor: document.getElementById(options.textColor).value,
                showGlobalText: document.getElementById(options.toggleText).checked,
                texts: {
                    leftTop: document.getElementById('leftTopText').value,
                    rightTop: document.getElementById('rightTopText').value,
                    leftQR: document.getElementById('leftQRText').value,
                    rightQR: document.getElementById('rightQRText').value,
                },
                individualText: {
                    toggle1: document.getElementById(individualTextControls.toggle).checked,
                    text1: document.getElementById(individualTextControls.text1).value,
                    size1: parseInt(document.getElementById(individualTextControls.size1.id).value),
                    x1: parseInt(document.getElementById(individualTextControls.x1.id).value),
                    y1: parseInt(document.getElementById(individualTextControls.y1.id).value),
                    toggle2: document.getElementById(individualTextControls.toggle2).checked,
                    text2: document.getElementById(individualTextControls.text2).value,
                    size2: parseInt(document.getElementById(individualTextControls.size2.id).value),
                    x2: parseInt(document.getElementById(individualTextControls.x2.id).value),
                    y2: parseInt(document.getElementById(individualTextControls.y2.id).value),
                }
            };
            
            const transferableBitmaps = Object.values(imgBitmaps);
            worker.postMessage({ imgBitmaps, params }, transferableBitmaps);

        }, 5); // ディレイを5msに変更
    };

    worker.onmessage = (e) => {
        const { imageBitmap } = e.data;
        canvas.width = imageBitmap.width;
        canvas.height = imageBitmap.height;
        ctx.drawImage(imageBitmap, 0, 0);
        
        preview.src = canvas.toDataURL('image/png');
        preview.classList.remove('hidden');
        downloadButton.classList.remove('hidden');
        clearButton.classList.remove('hidden');
        iosTip.classList.remove('hidden');
        mainWrapper.classList.add('preview-active');
        isMerging = false;
    };

    downloadButton.addEventListener('click', () => {
      const now = new Date();
      const timestamp = now.getFullYear().toString() + (now.getMonth() + 1).toString().padStart(2, '0') + now.getDate().toString().padStart(2, '0') + '_' +
                        now.getHours().toString().padStart(2, '0') + now.getMinutes().toString().padStart(2, '0') + now.getSeconds().toString().padStart(2, '0');
      const link = document.createElement('a');
      link.download = `merged-image_${timestamp}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    });

    clearButton.addEventListener('click', resetElements);

    // --- イベントリスナー設定 ---
    for (const name in elements) {
      const elem = elements[name];
      const dropZone = document.getElementById(elem.drop);
      const fileInput = document.getElementById(elem.input);
      const thumbImg = document.getElementById(elem.thumb);
      
      dropZone.addEventListener('click', () => fileInput.click());
      dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
      
      const handleFile = async (file) => {
        if (file && file.type.startsWith('image/')) {
          showThumbnail(file, dropZone, thumbImg);
          imgData[name] = await loadImage(file);
          scheduleMerge();
        }
      };
      
      dropZone.addEventListener('drop', async e => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFile(e.dataTransfer.files[0]);
      });
      
      fileInput.addEventListener('change', e => handleFile(e.target.files[0]));
      
      if (elem.text) {
        document.getElementById(elem.text).addEventListener('input', scheduleMerge);
      }
    }

    [options.toggleText, options.textColor].forEach(id => document.getElementById(id).addEventListener('input', scheduleMerge));
    Object.values(sliders).forEach(s => document.getElementById(s.id).addEventListener('input', scheduleMerge));
    
    // 個別テキスト関連
    const individualTextToggle1 = document.getElementById(individualTextControls.toggle);
    const individualTextDiv1 = document.querySelector('.individual-text-controls');
    const individualTextToggle2 = document.getElementById(individualTextControls.toggle2);
    const individualTextDiv2 = document.querySelector('.individual-text-controls2');
    
    individualTextToggle1.addEventListener('change', () => {
        individualTextDiv1.classList.toggle('hidden', !individualTextToggle1.checked);
        scheduleMerge();
    });
    individualTextToggle2.addEventListener('change', () => {
        individualTextDiv2.classList.toggle('hidden', !individualTextToggle2.checked);
        scheduleMerge();
    });

    [ 'text1', 'size1', 'x1', 'y1', 'text2', 'size2', 'x2', 'y2' ].forEach(key => {
        const targetId = typeof individualTextControls[key] === 'object' ? individualTextControls[key].id : individualTextControls[key];
        document.getElementById(targetId).addEventListener('input', scheduleMerge);
    });

    const adjustMobileLayout = () => {
      if (isMobile) {
        const qrSection = document.getElementById('qr-section');
        const qrInputGroups = qrSection.querySelectorAll('.qr-input-group');
        const containers = qrSection.querySelectorAll('.qr-group');
        
        // 元のグループをクリア
        containers.forEach(c => c.innerHTML = '');

        // 新しいグループを作成し、要素を再配置
        const newGroup1 = document.createElement('div');
        newGroup1.className = 'qr-group';
        newGroup1.appendChild(qrInputGroups[0]); // leftTop
        newGroup1.appendChild(qrInputGroups[2]); // leftQR
        
        const newGroup2 = document.createElement('div');
        newGroup2.className = 'qr-group';
        newGroup2.appendChild(qrInputGroups[1]); // rightTop
        newGroup2.appendChild(qrInputGroups[3]); // rightQR
        
        qrSection.innerHTML = '<h3>QRコード</h3>';
        qrSection.appendChild(newGroup1);
        qrSection.appendChild(newGroup2);
      }
    };
    
    // --- 初期化処理 ---
    initializeSliders();
    adjustMobileLayout();
    
  });
  </script>
</body>
</html>
