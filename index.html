<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>テストコード</title>
  <style>
    :root {
      --color-bg: #000000;
      --color-text: #ffffff;
      --color-dropzone-bg: #333;
      --color-dropzone-border: #ccc;
      --color-blue: #007bff;
      --color-blue-hover: #0056b3;
    }
    body {
      font-family: sans-serif;
      padding: 20px;
      background: var(--color-bg);
      color: var(--color-text);
      display: flex;
      gap: 20px;
      justify-content: center;
      min-height: 100vh;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .controls {
      flex: 1;
      max-width: 500px;
    }
    .preview-area {
      flex: 1;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      max-width: 500px;
    }
    .drop-zone {
      border: 2px dashed var(--color-dropzone-border);
      padding: 20px;
      text-align: center;
      margin-bottom: 10px;
      background: var(--color-dropzone-bg);
      color: var(--color-text);
      cursor: pointer;
      transition: border-color 0.2s ease;
    }
    .drop-zone.qr {
      display: inline-block;
      width: calc(50% - 15px);
      margin-right: 10px;
      vertical-align: top;
    }
    .drop-zone.qr:last-of-type {
      margin-right: 0;
    }
    .drop-zone.dragover {
      border-color: var(--color-blue);
    }
    .preview-thumb {
      max-width: 100px;
      max-height: 100px;
      display: block;
      margin: 10px auto;
    }
    input[type="file"] {
      display: none;
    }
    #canvas {
      display: none;
    }
    #preview {
      max-width: 100%;
      height: auto;
      border: 1px solid var(--color-dropzone-border);
      margin-bottom: 20px;
    }
    .qr-group {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .qr-input-group {
      width: calc(50% - 10px);
    }
    .slider-group {
      width: 100%;
      max-width: 600px;
      margin-top: 5px;
      text-align: left;
    }
    input[type="range"] {
      width: 100%;
      height: 25px;
    }
    #downloadButton {
      padding: 15px 30px;
      font-size: 20px;
      width: 250px;
      background-color: var(--color-blue);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-top: 20px;
    }
    #downloadButton:hover {
      background-color: var(--color-blue-hover);
    }
    .controls-group {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-top: 20px;
      justify-content: center;
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>

  <div class="controls">
    <h2>背景画像</h2>

    <div class="drop-zone" id="mainDrop">背景画像をここにドロップまたはクリック</div>
    <input type="file" accept="image/*" id="mainInput">
    <img id="mainThumb" class="preview-thumb hidden" alt="背景画像プレビュー"><br>

    <hr>
    <h3>QRコード</h3>

    <div class="qr-group">
      <div class="qr-input-group">
        <label for="leftTopText">テキスト:</label>
        <input type="text" id="leftTopText" value="先１">
        <div class="drop-zone" id="leftTopDrop">左上QR画像をここにドロップまたはクリック</div>
        <input type="file" accept="image/*" id="leftTopInput">
        <img id="leftTopThumb" class="preview-thumb hidden" alt="左上QRプレビュー"><br>
      </div>

      <div class="qr-input-group">
        <label for="rightTopText">テキスト:</label>
        <input type="text" id="rightTopText" value="後１">
        <div class="drop-zone" id="rightTopDrop">右上QR画像をここにドロップまたはクリック</div>
        <input type="file" accept="image/*" id="rightTopInput">
        <img id="rightTopThumb" class="preview-thumb hidden" alt="右上QRプレビュー"><br>
      </div>
    </div>

    <div class="qr-group">
      <div class="qr-input-group">
        <label for="leftQRText">テキスト:</label>
        <input type="text" id="leftQRText" value="先２">
        <div class="drop-zone" id="leftQRDrop">左下QR画像をここにドロップまたはクリック</div>
        <input type="file" accept="image/*" id="leftQRInput">
        <img id="leftThumb" class="preview-thumb hidden" alt="左QRプレビュー"><br>
      </div>

      <div class="qr-input-group">
        <label for="rightQRText">テキスト:</label>
        <input type="text" id="rightQRText" value="後２">
        <div class="drop-zone" id="rightQRDrop">右下QR画像をここにドロップまたはクリック</div>
        <input type="file" accept="image/*" id="rightQRInput">
        <img id="rightThumb" class="preview-thumb hidden" alt="右QRプレビュー"><br>
      </div>
    </div>
  </div>

  <div class="preview-area">
    <h3>合成画像プレビュー</h3>
    <img id="preview" alt="合成画像プレビュー" class="hidden">
    
    <div class="controls-group">
      <label>
        <input type="checkbox" id="toggleText" checked> テキストを表示
      </label>
      <label for="textColorPicker">テキストの色</label>
      <input type="color" id="textColorPicker" value="#ffffff">
    </div>
    
    <div class="slider-group">
      <label for="left-qr-offset">左QR位置調整</label>
      <input type="range" id="left-qr-offset" min="-700" max="800" value="0">
    </div>
    <div class="slider-group">
      <label for="right-qr-offset">右QR位置調整</label>
      <input type="range" id="right-qr-offset" min="-1200" max="200" value="0">
    </div>
    <div class="slider-group">
        <label for="top-qr-vertical-offset">上QR位置調整</label>
        <input type="range" id="top-qr-vertical-offset" min="-500" max="500" value="0">
    </div>
    <div class="slider-group">
        <label for="bottom-qr-vertical-offset">下QR位置調整</label>
        <input type="range" id="bottom-qr-vertical-offset" min="-500" max="500" value="0">
    </div>
    <div class="slider-group">
        <label for="text-size">テキストサイズ調整</label>
        <input type="range" id="text-size" min="10" max="150" value="45">
    </div>

    <button id="downloadButton" class="hidden">画像をダウンロード</button>
  </div>

<canvas id="canvas"></canvas>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const elements = {
    main: { input: 'mainInput', drop: 'mainDrop', thumb: 'mainThumb', img: null },
    leftTop: { input: 'leftTopInput', drop: 'leftTopDrop', thumb: 'leftTopThumb', text: 'leftTopText', img: null },
    rightTop: { input: 'rightTopInput', drop: 'rightTopDrop', thumb: 'rightTopThumb', text: 'rightTopText', img: null },
    leftQR: { input: 'leftQRInput', drop: 'leftQRDrop', thumb: 'leftThumb', text: 'leftQRText', img: null },
    rightQR: { input: 'rightQRInput', drop: 'rightQRDrop', thumb: 'rightThumb', text: 'rightQRText', img: null }
  };

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const preview = document.getElementById('preview');
  const downloadButton = document.getElementById('downloadButton');
  
  const sliders = {
    leftOffset: 'left-qr-offset',
    rightOffset: 'right-qr-offset',
    topVertical: 'top-qr-vertical-offset',
    bottomVertical: 'bottom-qr-vertical-offset',
    textSize: 'text-size'
  };

  const options = {
    toggleText: 'toggleText',
    textColor: 'textColorPicker'
  };

  const imgData = {};

  const debounce = (func, delay) => {
    let timeoutId;
    return (...args) => {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => func(...args), delay);
    };
  };

  const loadImage = (file) => {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = reject;
      const reader = new FileReader();
      reader.onload = e => img.src = e.target.result;
      reader.readAsDataURL(file);
    });
  };
  
  const showThumbnail = (file, imgElem) => {
    const reader = new FileReader();
    reader.onload = e => {
      imgElem.src = e.target.result;
      imgElem.classList.remove('hidden');
    };
    reader.readAsDataURL(file);
  };
  
  const tryMerge = () => {
    const mainImg = imgData.main;
    if (!mainImg) {
      preview.classList.add('hidden');
      downloadButton.classList.add('hidden');
      return;
    }

    canvas.width = mainImg.width;
    canvas.height = mainImg.height;
    ctx.drawImage(mainImg, 0, 0);

    const qrWidth = mainImg.width * 0.15;
    const qrHeight = qrWidth;
    const qrMargin = mainImg.width * 0.02;
    
    const qrOffsets = {
      left: parseInt(document.getElementById(sliders.leftOffset).value),
      right: parseInt(document.getElementById(sliders.rightOffset).value),
      top: parseInt(document.getElementById(sliders.topVertical).value),
      bottom: parseInt(document.getElementById(sliders.bottomVertical).value)
    };

    const topY = mainImg.height * 0.2 + qrOffsets.top;
    const bottomY = mainImg.height * 0.2 + qrOffsets.bottom + mainImg.height * 0.15;
    const textSize = parseInt(document.getElementById(sliders.textSize).value);
    const showText = document.getElementById(options.toggleText).checked;

    ctx.fillStyle = document.getElementById(options.textColor).value;
    ctx.font = `bold ${textSize}px Arial`;
    ctx.textAlign = 'center';

    const qrPositions = {
      leftTop: { img: imgData.leftTop, x: qrMargin + 540 + qrOffsets.left, y: topY, text: elements.leftTop.text },
      rightTop: { img: imgData.rightTop, x: mainImg.width - qrWidth - qrMargin + qrOffsets.right, y: topY, text: elements.rightTop.text },
      leftQR: { img: imgData.leftQR, x: qrMargin + 540 + qrOffsets.left, y: bottomY, text: elements.leftQR.text },
      rightQR: { img: imgData.rightQR, x: mainImg.width - qrWidth - qrMargin + qrOffsets.right, y: bottomY, text: elements.rightQR.text }
    };
    
    for (const key in qrPositions) {
      const pos = qrPositions[key];
      if (pos.img) {
        ctx.drawImage(pos.img, pos.x, pos.y, qrWidth, qrHeight);
        if (showText) {
          const text = document.getElementById(pos.text).value;
          ctx.fillText(text, pos.x + qrWidth / 2, pos.y - 40);
        }
      }
    }

    preview.src = canvas.toDataURL('image/png');
    preview.classList.remove('hidden');
    downloadButton.classList.remove('hidden');
  };

  downloadButton.addEventListener('click', () => {
    const link = document.createElement('a');
    link.download = 'merged-image.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  });

  for (const name in elements) {
    const elem = elements[name];
    const dropZone = document.getElementById(elem.drop);
    const fileInput = document.getElementById(elem.input);
    const thumbImg = document.getElementById(elem.thumb);
    const textInput = elem.text ? document.getElementById(elem.text) : null;
    
    dropZone.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
    
    dropZone.addEventListener('dragenter', e => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', async e => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) {
        showThumbnail(file, thumbImg);
        imgData[name] = await loadImage(file);
        tryMerge();
      }
    });

    fileInput.addEventListener('change', async e => {
      const file = e.target.files[0];
      if (file) {
        showThumbnail(file, thumbImg);
        imgData[name] = await loadImage(file);
        tryMerge();
      }
    });

    if (textInput) {
      textInput.addEventListener('input', tryMerge);
    }
  }

  const debouncedMerge = debounce(tryMerge, 100);
  for (const key in sliders) {
    document.getElementById(sliders[key]).addEventListener('input', debouncedMerge);
  }
  document.getElementById(options.toggleText).addEventListener('change', tryMerge);
  document.getElementById(options.textColor).addEventListener('input', tryMerge);
});
</script>

</body>
</html>
